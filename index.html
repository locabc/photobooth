<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const photoStrip4x2 = document.getElementById('photo-strip-4x2');
    const photoStrip6x2 = document.getElementById('photo-strip-6x2');
    const photoStrip8x2 = document.getElementById('photo-strip-8x2');
    const retakeButton = document.getElementById('retake');
    const downloadButton = document.getElementById('download');
    const resetLayoutButton = document.getElementById('reset-layout');
    const layoutSelection = document.getElementById('layout-selection');
    const mainControls = document.getElementById('main-controls');
    let photos = [];
    let currentFilter = 'none';
    let frameColor = '#FFFFFF';
    let sticker = 'none';
    let rowsPerSide = 0;
    let colsPerSide = 1;
    let currentLayout = '';

    window.onload = () => {
        photoStrip4x2.style.display = 'none';
        photoStrip6x2.style.display = 'none';
        photoStrip8x2.style.display = 'none';
        checkCameraPermission();
    };

    async function checkCameraPermission() {
        try {
            const permissionStatus = await navigator.permissions.query({ name: 'camera' });
            if (permissionStatus.state === 'granted') {
                startWebcam();
            } else if (permissionStatus.state === 'prompt') {
                startWebcam();
            } else {
                alert('Quy·ªÅn truy c·∫≠p camera b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát ho·∫∑c thi·∫øt b·ªã.');
            }
        } catch (err) {
            console.error('Kh√¥ng th·ªÉ ki·ªÉm tra quy·ªÅn camera:', err);
            startWebcam();
        }
    }

    async function startWebcam() {
        try {
            const constraints = { 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }
                } 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            };
        } catch (err) {
            console.error('Kh√¥ng th·ªÉ truy c·∫≠p webcam:', err);
            alert('L·ªói khi truy c·∫≠p camera: ' + err.message);
        }
    }

    async function loadFaceApiModels() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model/');
            console.log('M√¥ h√¨nh nh·∫≠n di·ªán ƒë√£ s·∫µn s√†ng');
        } catch (err) {
            console.error('Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t:', err);
        }
    }

    Promise.all([loadFaceApiModels()]).then(() => {
        console.log('·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng');
    });

    document.getElementById('snap').addEventListener('click', async () => {
        if (photos.length >= rowsPerSide * colsPerSide * 2) return;

        ctx.save();
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1); // L·∫≠t ·∫£nh ƒë·ªÉ gi·ªëng khung video
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();

        if (sticker !== 'none') {
            const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());
            if (detections.length > 0) {
                const face = detections[0].box;
                ctx.font = sticker === 'üêª' ? '150px Arial' : sticker === 'üê∞' ? '80px Arial' : '50px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                const stickerX = face.x + face.width / 2;
                const stickerY = sticker === 'üê∞' ? face.y - 50 : face.y - 10;
                ctx.fillText(sticker, stickerX, stickerY);
            }
        }

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < imageData.data.length; i += 4) {
            let r = imageData.data[i];
            let g = imageData.data[i + 1];
            let b = imageData.data[i + 2];
            if (currentFilter === 'grayscale') {
                const gray = 0.3 * r + 0.59 * g + 0.11 * b;
                imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = gray;
            } else if (currentFilter === 'sepia') {
                imageData.data[i] = r * 0.393 + g * 0.769 + b * 0.189;
                imageData.data[i + 1] = r * 0.349 + g * 0.686 + b * 0.168;
                imageData.data[i + 2] = r * 0.272 + g * 0.534 + b * 0.131;
            } else if (currentFilter === 'vibrant') {
                imageData.data[i] = Math.min(255, r * 1.2);
                imageData.data[i + 1] = Math.min(255, g * 1.1);
                imageData.data[i + 2] = Math.min(255, b * 1.2);
            } else if (currentFilter === 'warm') {
                imageData.data[i] = Math.min(255, r * 1.1);
                imageData.data[i + 1] = Math.min(255, g * 0.9);
                imageData.data[i + 2] = Math.min(255, b * 0.8);
            } else if (currentFilter === 'cool') {
                imageData.data[i] = Math.min(255, r * 0.8);
                imageData.data[i + 1] = Math.min(255, g * 0.9);
                imageData.data[i + 2] = Math.min(255, b * 1.1);
            } else if (currentFilter === 'retro') {
                imageData.data[i] = Math.min(255, r * 0.8 + 40);
                imageData.data[i + 1] = Math.min(255, g * 0.9);
                imageData.data[i + 2] = Math.min(255, b * 0.7);
            } else if (currentFilter === 'dreamy') {
                imageData.data[i] = Math.min(255, r + 20);
                imageData.data[i + 1] = Math.min(255, g + 20);
                imageData.data[i + 2] = Math.min(255, b + 40);
            } else if (currentFilter === 'invert') {
                imageData.data[i] = 255 - r;
                imageData.data[i + 1] = 255 - g;
                imageData.data[i + 2] = 255 - b;
            }
        }
        ctx.putImageData(imageData, 0, 0);

        // L∆∞u ·∫£nh v·ªõi ch·∫•t l∆∞·ª£ng cao
        photos.push(canvas.toDataURL('image/jpeg', 1.0));
        updatePhotoStrip();
        retakeButton.style.display = 'inline-block';
        if (photos.length >= rowsPerSide * colsPerSide * 2) {
            document.getElementById('snap').disabled = true;
            downloadButton.style.display = 'inline-block';
        }
    });

    retakeButton.addEventListener('click', () => {
        if (photos.length > 0) {
            photos.pop();
            updatePhotoStrip();
            document.getElementById('snap').disabled = false;
            retakeButton.style.display = 'none';
            downloadButton.style.display = 'none';
        }
    });

    document.getElementById('save').addEventListener('click', () => {
        if (photos.length === 0) return;
        updatePhotoStrip();
        downloadButton.style.display = 'inline-block';
    });

    downloadButton.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'photobooth-strip.jpg';
        const currentStrip = getCurrentPhotoStrip();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const photoWidth = 280; // TƒÉng k√≠ch th∆∞·ªõc ƒë·ªÉ gi·ªØ ch·∫•t l∆∞·ª£ng
        const photoHeight = 200;
        const borderWidth = 20;
        const gap = 20; // Kho·∫£ng c√°ch gi·ªØa hai b√™n
        const photoGap = 10; // Kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh trong c√πng m·ªôt b√™n

        // T√≠nh to√°n k√≠ch th∆∞·ªõc canvas
        canvas.width = (photoWidth * 2) + gap + (borderWidth * 2);
        canvas.height = (photoHeight * rowsPerSide) + (photoGap * (rowsPerSide - 1)) + (borderWidth * 2);

        ctx.fillStyle = frameColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        photos.forEach((photo, index) => {
            const img = new Image();
            img.src = photo;
            img.onload = () => {
                const side = index < rowsPerSide ? 0 : 1;
                const row = index % rowsPerSide;
                const x = side === 0 ? borderWidth : borderWidth + photoWidth + gap;
                const y = borderWidth + (row * (photoHeight + photoGap));
                ctx.drawImage(img, x, y, photoWidth, photoHeight);

                // Ki·ªÉm tra n·∫øu ƒë√¢y l√† ·∫£nh cu·ªëi c√πng th√¨ t·∫£i xu·ªëng
                if (index === photos.length - 1) {
                    link.href = canvas.toDataURL('image/jpeg', 1.0); // Ch·∫•t l∆∞·ª£ng t·ªëi ƒëa
                    link.click();
                }
            };
        });
    });

    resetLayoutButton.addEventListener('click', () => {
        rowsPerSide = 0;
        colsPerSide = 1;
        photos = [];
        currentLayout = '';
        layoutSelection.style.display = 'block';
        mainControls.style.display = 'none';
        photoStrip4x2.style.display = 'none';
        photoStrip6x2.style.display = 'none';
        photoStrip8x2.style.display = 'none';
        document.getElementById('snap').disabled = true;
        retakeButton.style.display = 'none';
        downloadButton.style.display = 'none';
        resetLayoutButton.style.display = 'none';
        resetPhotoStrip();
    });

    function getCurrentPhotoStrip() {
        if (currentLayout === '4x2') return photoStrip4x2;
        if (currentLayout === '6x2') return photoStrip6x2;
        if (currentLayout === '8x2') return photoStrip8x2;
        return null;
    }

    function resetPhotoStrip() {
        const currentStrip = getCurrentPhotoStrip();
        if (currentStrip) {
            const leftSide = currentStrip.querySelector('.left-side');
            const rightSide = currentStrip.querySelector('.right-side');
            leftSide.innerHTML = '';
            rightSide.innerHTML = '';
            const slotsPerSide = rowsPerSide;
            for (let i = 0; i < slotsPerSide; i++) {
                const leftDiv = document.createElement('div');
                const rightDiv = document.createElement('div');
                leftDiv.textContent = 'Empty';
                rightDiv.textContent = 'Empty';
                leftSide.appendChild(leftDiv);
                rightSide.appendChild(rightDiv);
            }
            currentStrip.style.background = frameColor;
        }
    }

    function updatePhotoStrip() {
        const currentStrip = getCurrentPhotoStrip();
        if (!currentStrip) return;

        const leftSide = currentStrip.querySelector('.left-side');
        const rightSide = currentStrip.querySelector('.right-side');
        const slotsPerSide = rowsPerSide;

        leftSide.innerHTML = '';
        rightSide.innerHTML = '';

        for (let i = 0; i < slotsPerSide; i++) {
            const leftDiv = document.createElement('div');
            if (i < photos.length) {
                const img = new Image();
                img.src = photos[i];
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.transform = 'scaleX(-1)'; // L·∫≠t l·∫°i ·∫£nh ƒë·ªÉ gi·ªëng khung ch·ª•p
                leftDiv.appendChild(img);
            } else {
                leftDiv.textContent = 'Empty';
            }
            leftSide.appendChild(leftDiv);
        }

        for (let i = slotsPerSide; i < slotsPerSide * 2; i++) {
            const rightDiv = document.createElement('div');
            if (i < photos.length) {
                const img = new Image();
                img.src = photos[i];
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.transform = 'scaleX(-1)'; // L·∫≠t l·∫°i ·∫£nh ƒë·ªÉ gi·ªëng khung ch·ª•p
                rightDiv.appendChild(img);
            } else {
                rightDiv.textContent = 'Empty';
            }
            rightSide.appendChild(rightDiv);
        }

        currentStrip.style.borderColor = frameColor;
        currentStrip.style.background = frameColor;
        currentStrip.classList.add('selected');
        currentStrip.style.display = 'flex';
    }

    function setLayout(newRows, newCols) {
        rowsPerSide = newRows;
        colsPerSide = 1;
        currentLayout = `${newRows}x${newCols}`;
        photos = [];
        layoutSelection.style.display = 'none';
        mainControls.style.display = 'block';
        resetLayoutButton.style.display = 'inline-block';

        photoStrip4x2.style.display = 'none';
        photoStrip6x2.style.display = 'none';
        photoStrip8x2.style.display = 'none';

        if (currentLayout === '4x2') {
            photoStrip4x2.style.display = 'flex';
        } else if (currentLayout === '6x2') {
            photoStrip6x2.style.display = 'flex';
        } else if (currentLayout === '8x2') {
            photoStrip8x2.style.display = 'flex';
        }

        document.getElementById('snap').disabled = false;
        resetPhotoStrip();
        updatePhotoStrip();
        updateButtonSelection('layout-btn', `${newRows}x${newCols}`);
    }

    function setFilter(filter) {
        currentFilter = filter;
        updateButtonSelection('filter-btn', filter);
    }

    function setFrameColor(color) {
        frameColor = color;
        updatePhotoStrip();
        updateButtonSelection('frame-color', color);
    }

    function setSticker(stickerType) {
        sticker = stickerType;
        updateButtonSelection('sticker-btn', stickerType);
    }

    function updateButtonSelection(className, value) {
        document.querySelectorAll(`.${className}`).forEach(btn => {
            btn.classList.remove('selected');
            if (btn.getAttribute('onclick').includes(value)) {
                btn.classList.add('selected');
            }
        });
    }

    if (/Mobi|Android|iPhone|iPad/.test(navigator.userAgent)) {
        document.body.style.padding = '5px';
        document.querySelectorAll('button').forEach(btn => {
            btn.style.width = 'auto';
            btn.style.minWidth = '60px';
        });
    }
</script>
