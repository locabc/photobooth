<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Photobooth Web</title>
    <img src="https://i.imgur.com/8e2HpbM.png" id="customFrameImage" style="display: none;" preload crossOrigin="anonymous" onerror="console.error('Failed to load custom frame image from Imgur. Check URL or CORS settings.');">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f0f0f0;
            margin: 0;
            padding: 10px;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: #000;
            padding: 10px;
            border-radius: 15px;
        }
        #video {
            width: 100%;
            max-width: 480px;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 2px solid #fff;
            border-radius: 15px;
        }
        #live-canvas {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            max-width: 480px;
            height: auto;
            border: 2px solid #fff;
            border-radius: 15px;
        }
        #photo-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        #canvas { 
            display: none; 
            width: 100%; 
            max-width: 480px; 
            height: auto; 
        }
        #photo-preview-container, #captured-photos-container {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }
        .photo-preview {
            width: 110px;
            height: 90px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        #camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
            position: relative;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 24px;
        }
        #snap-btn {
            width: 70px;
            height: 70px;
            background: #2196F3;
            border: none;
            color: white;
        }
        #snap-btn:hover {
            background: #1976D2;
        }
        #flash-btn.active {
            background: #FFD700;
        }
        #timer-options {
            display: none;
            position: absolute;
            top: -150px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
        }
        #timer-options button {
            display: block;
            width: 100%;
            padding: 5px;
            margin: 2px 0;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
        }
        #timer-options button:hover {
            background: #ddd;
        }
        #controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .filter-btn, .sticker-btn, .layout-btn, .frame-btn, .background-btn {
            padding: 8px;
            margin: 3px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .filter-btn:hover, .sticker-btn:hover, .layout-btn:hover, .frame-btn:hover, .background-btn:hover {
            background: #ddd;
        }
        .layout-btn.selected, .filter-btn.selected, .sticker-btn.selected, .frame-btn.selected, .background-btn.selected {
            border: 2px solid #ff0000;
            background: #e0e0e0;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), 0 0 25px rgba(255, 0, 0, 0.4);
            transform: scale(1.1);
        }
        .layout-btn {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #download, #reset-layout {
            padding: 10px;
            margin: 0 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            width: 120px;
            text-align: center;
        }
        #download {
            background: #4CAF50;
            color: white;
        }
        #download:hover {
            background: #45a049;
        }
        #reset-layout {
            display: none;
            background: #9c27b0;
            color: white;
        }
        #reset-layout:hover {
            background: #7b1fa2;
        }
        #layout-selection {
            display: none;
        }
        #main-controls > div:first-child {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #photo-selection-container {
            display: none;
            margin-top: 20px;
        }
        .photo-selection {
            position: relative;
            margin: 5px;
        }
        .photo-selection img {
            width: 110px;
            height: 90px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        .photo-selection img.selected {
            border: 3px solid #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        /* ...existing styles... */
        .photo-strip {
            display: flex;
            /* justify-content: center; */ /* Let specific rules handle this */
            width: 100%;
            max-width: 400px; /* Consistent max-width */
            padding: 30px;
            margin: 0 auto;
            box-sizing: border-box;
            background: #fff; /* Default background */
            gap: 20px; /* Add gap for 4x2 layout */
        }
        .layout-preview {
            /* width: 42%; */ /* Remove percentage width */
            width: 150px; /* Set fixed width */
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0; /* Remove specific margins */
            gap: 10px;
        }
        /* Remove specific margin rules */
        .layout-preview.left-side { /* No longer needed */ }
        .layout-preview.right-side { /* No longer needed */ }

        .layout-preview div {
            background: #f0f0f0;
            border: 1px solid #ddd;
            height: 120px; /* Keep height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 12px;
            /* width: 100%; */ /* Remove percentage width */
            width: 150px; /* Set fixed width */
            box-sizing: border-box;
            overflow: hidden;
        }
        .layout-preview div img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #photo-strip-1x4 {
            padding: 30px; /* Consistent padding */
            justify-content: center; /* Center the single column */
            gap: 0; /* No gap needed for single column */
        }
        #photo-strip-1x4 .layout-preview {
            /* width: 100%; */ /* Remove */
            /* max-width: 260px; */ /* Remove */
            width: 150px; /* Match the div width */
            margin: 0; /* Remove auto margin if centering is done by parent */
            gap: 10px;
        }
        #photo-strip-4x2 {
             justify-content: center; /* Center the two columns */
             /* Gap is already set in .photo-strip */
        }

        /* Ensure layout page and controls have appropriate display */
        .layout-page {
            display: none; /* Initially hidden, shown by JS */
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
/* ...rest of existing styles... */
        .layout-controls {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .layout-preview-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tab-btn {
            padding: 5px 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab-btn.active {
            background: #2196F3;
            color: white;
        }
        .tab-content {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            cursor: pointer;
            border-radius: 5px;
        }
        .color-btn.gradient {
            background: linear-gradient(45deg, #FF0000, #FFFF00);
        }
        .color-picker {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .color-picker input {
            width: 40px;
            height: 40px;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        .layout-tips {
            margin-top: 10px;
            text-align: left;
            font-size: 14px;
            color: #666;
        }
        .layout-actions {
            display: none;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .layout-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #retake-btn-layout {
            background: #ddd;
        }
        #send-to-phone {
            background: #FF9800;
            color: white;
        }
        #qr-code {
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            #download, #reset-layout {
                padding: 8px;
                font-size: 14px;
                width: 100px;
            }
            .layout-preview {
                width: 40%;
                gap: 8px;
            }
            .layout-preview.left-side {
                margin-right: 6%;
            }
            .layout-preview.right-side {
                margin-left: 6%;
            }
            .layout-preview div {
                height: 100px;
                font-size: 10px;
            }
            #photo-strip-1x4 .layout-preview {
                max-width: 220px;
            }
            #photo-strip-1x4 {
                padding: 40px;
            }
            #video-container {
                max-width: 360px;
            }
            .photo-preview, .photo-selection img {
                width: 80px;
                height: 60px;
            }
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            #snap-btn {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <h1>Photobooth</h1>
    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="live-canvas"></canvas>
        <div id="photo-count">0/8</div>
    </div>
    <div id="photo-preview-container"></div>
    <div id="camera-controls">
        <button class="control-btn" id="retake-btn" onclick="goBack()">‚¨ÖÔ∏è</button>
        <button class="control-btn" id="timer-btn" onclick="toggleTimerOptions()">‚è≤Ô∏è</button>
        <div id="timer-options">
            <button onclick="setTimer(0)">T·∫Øt</button>
            <button onclick="setTimer(1)">1s</button>
            <button onclick="setTimer(3)">3s</button>
            <button onclick="setTimer(5)">5s</button>
            <button onclick="setTimer(10)">10s</button>
        </div>
        <button class="control-btn" id="snap-btn" disabled>üì∑</button>
        <button class="control-btn" onclick="switchCamera()">üîÑ</button>
        <button class="control-btn" id="flash-btn" onclick="toggleFlash()">‚ö°</button>
    </div>
    <div id="captured-photos-container"></div>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <div id="layout-selection">
            <h3>Select Layout</h3>
            <button class="layout-btn" onclick="setLayout(4, 2)">8 pictures</button>
            <button class="layout-btn" onclick="setLayout(4, 1)">4 pictures</button>
        </div>
        <div id="main-controls">
            <div>
                <button id="reset-layout">Reset</button>
            </div>
            <div>
                <h3>Select Filter</h3>
                <button class="filter-btn" onclick="setFilter('none')">No Filter</button>
                <button class="filter-btn" onclick="setFilter('grayscale')">Black & White</button>
                <button class="filter-btn" onclick="setFilter('sepia')">Sepia</button>
                <button class="filter-btn" onclick="setFilter('vibrant')">Vibrant</button>
                <button class="filter-btn" onclick="setFilter('warm')">Warm</button>
                <button class="filter-btn" onclick="setFilter('cool')">Cool</button>
                <button class="filter-btn" onclick="setFilter('retro')">Retro</button>
                <button class="filter-btn" onclick="setFilter('dreamy')">Dreamy</button>
                <button class="filter-btn" onclick="setFilter('invert')">Invert</button>
            </div>
            <div>
                <h3>Select Sticker</h3>
                <button class="sticker-btn" onclick="setSticker('none')">No Sticker</button>
                <button class="sticker-btn" onclick="setSticker('üò∫')">Cat</button>
                <button class="sticker-btn" onclick="setSticker('üëë')">Crown</button>
                <button class="sticker-btn" onclick="setSticker('üåü')">Star</button>
                <button class="sticker-btn" onclick="setSticker('üêª')">Bear</button>
                <button class="sticker-btn" onclick="setSticker('üê∞')">Rabbit</button>
                <button class="sticker-btn" onclick="setSticker('‚ù§Ô∏è')">Heart</button>
                <br>                
                <button class="sticker-btn" onclick="setSticker('üéà')">Balloon</button>
                <button class="sticker-btn" onclick="setSticker('üéâ')">Party Popper</button>
                <button class="sticker-btn" onclick="setSticker('üéÇ')">Birthday Cake</button>
                <button class="sticker-btn" onclick="setSticker('üéÅ')">Gift</button>
            </div>
        </div>
    </div>
    <div id="photo-selection-container">
        <h3>Select Photos for Layout</h3>
        <div>
            <button class="layout-btn" onclick="selectLayout('4x2')">8 (All Photos)</button>
            <button class="layout-btn" onclick="selectLayout('4x1')">4 (Choose 4 Photos)</button>
        </div>
        <div id="photo-selection-list"></div>
    </div>
    <div id="photo-strip-container" class="layout-page">
        <div class="layout-controls">
            <h3>Frame Customization</h3>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('solid-colors')">Solid Colors</button>
                <button class="tab-btn" onclick="showTab('gradients')">Gradients</button>
                <button class="tab-btn" onclick="showTab('frames')">Frames</button>
            </div>
            <div id="solid-colors" class="tab-content">
                <button class="color-btn" style="background: #FFFFFF;" onclick="setBackgroundColor('#FFFFFF')"></button>
                <button class="color-btn" style="background: #000000;" onclick="setBackgroundColor('#000000')"></button>
                <button class="color-btn" style="background: #D3D3D3;" onclick="setBackgroundColor('#D3D3D3')"></button>
                <button class="color-btn" style="background: #808080;" onclick="setBackgroundColor('#808080')"></button>
                <button class="color-btn" style="background: #8B0000;" onclick="setBackgroundColor('#8B0000')"></button>
                <button class="color-btn" style="background: #00008B;" onclick="setBackgroundColor('#00008B')"></button>
                <button class="color-btn" style="background: #FFFFE0;" onclick="setBackgroundColor('#FFFFE0')"></button>
                <button class="color-btn" style="background: #FFDAB9;" onclick="setBackgroundColor('#FFDAB9')"></button>
                <button class="color-btn" style="background: #FFB6C1;" onclick="setBackgroundColor('#FFB6C1')"></button>
                <button class="color-btn" style="background: #E6E6FA;" onclick="setBackgroundColor('#E6E6FA')"></button>
                <button class="color-btn" style="background: #E0FFFF;" onclick="setBackgroundColor('#E0FFFF')"></button>
                <button class="color-btn" style="background: #F0FFF0;" onclick="setBackgroundColor('#F0FFF0')"></button>
                <div class="color-picker">
                    <input type="color" id="color-picker" onchange="setBackgroundColor(this.value)">
                    <span>Color: #FFFFFF</span>
                </div>
            </div>
            <div id="gradients" class="tab-content" style="display: none;">
                <button class="color-btn gradient" onclick="setBackgroundColor('linear-gradient(45deg, #FF0000, #FFFF00)')">Red-Yellow</button>
                <button class="color-btn gradient" onclick="setBackgroundColor('linear-gradient(45deg, #00FF00, #0000FF)')">Green-Blue</button>
            </div>
            <div id="frames" class="tab-content" style="display: none;">
                <button class="frame-btn" onclick="setFrame('none')">No Frame</button>
                <button class="frame-btn" onclick="setFrame('summer')">Summer</button>
                <button class="frame-btn" onclick="setFrame('spring')">Spring</button>
                <button class="frame-btn" onclick="setFrame('winter')">Winter</button>
                <button class="frame-btn" onclick="setFrame('heart')">Heart</button>
                <button class="frame-btn" onclick="setFrame('autumn')">Autumn</button>
                <button class="frame-btn" onclick="setFrame('custom')">Custom Frame</button>
            </div>
        </div>
        <div class="layout-preview-container">
            <h3>Layout Preview</h3>
            <div id="photo-strip-4x2" class="photo-strip">
                <div class="layout-preview left-side">
                    <div>Empty</div><div>Empty</div><div>Empty</div><div>Empty</div>
                </div>
                <div class="layout-preview right-side">
                    <div>Empty</div><div>Empty</div><div>Empty</div><div>Empty</div>
                </div>
            </div>
            <div id="photo-strip-1x4" class="photo-strip">
                <div class="layout-preview">
                    <div>Empty</div><div>Empty</div><div>Empty</div><div>Empty</div>
                </div>
            </div>
            <div class="layout-tips">
                <p>üé® <strong>Layout Tips</strong><br>Choose your favorite colors and customize the frame by selecting a photo strip. Use the color picker to fine-tune. When satisfied, press the Download button below.</p>
            </div>
        </div>
    </div>
    <div id="layout-actions" class="layout-actions">
        <button id="retake-btn-layout" onclick="resetLayoutButton.click()">‚¨ÖÔ∏è Retake</button>
        <button id="download">Download</button>
        <button id="send-to-phone" onclick="generateQRCode()">Send to Phone</button>
        <div id="qr-code" style="display: none; margin-top: 10px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const liveCanvas = document.getElementById('live-canvas');
        const ctx = canvas.getContext('2d');
        const liveCtx = liveCanvas.getContext('2d');
        const photoStrip4x2 = document.getElementById('photo-strip-4x2');
        const photoStrip1x4 = document.getElementById('photo-strip-1x4');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const capturedPhotosContainer = document.getElementById('captured-photos-container');
        const photoSelectionContainer = document.getElementById('photo-selection-container');
        const photoSelectionList = document.getElementById('photo-selection-list');
        const retakeButton = document.getElementById('retake-btn');
        const downloadButton = document.getElementById('download');
        const resetLayoutButton = document.getElementById('reset-layout');
        const layoutSelection = document.getElementById('layout-selection');
        const mainControls = document.getElementById('main-controls');
        const customFrameImage = document.getElementById('customFrameImage');
        const snapBtn = document.getElementById('snap-btn');
        const flashBtn = document.getElementById('flash-btn');
        const timerOptions = document.getElementById('timer-options');
        const timerBtn = document.getElementById('timer-btn');
        const photoCount = document.getElementById('photo-count');
        let photos = [];
        let selectedPhotos = [];
        let currentFilter = 'none';
        let sticker = 'none';
        let frameType = 'none';
        let frameColor = '#FFFFFF';
        let rowsPerSide = 0;
        let colsPerSide = 1;
        let currentLayout = '';
        let stream = null;
        let animationFrameId = null;
        let flashOn = false;
        let timerSeconds = 0;
        let facePosition = null;
        let currentFacingMode = 'user';

        window.onload = () => {
            photoStrip4x2.style.display = 'none';
            photoStrip1x4.style.display = 'none';
            retakeButton.style.display = 'none';
            checkCameraPermission();
        };

        async function checkCameraPermission() {
            try {
                const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                if (permissionStatus.state === 'granted' || permissionStatus.state === 'prompt') {
                    startWebcam();
                } else {
                    alert('Camera access denied.');
                }
            } catch (err) {
                console.error('Error checking camera permissions:', err);
                startWebcam();
            }
        }

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    liveCanvas.width = video.videoWidth;
                    liveCanvas.height = video.videoHeight;
                    liveCanvas.style.display = 'block'; // Ensure live canvas is visible
                    snapBtn.disabled = false;
                    applyFilterLive(); // Start live filter rendering
                };
            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Error accessing camera: ' + err.message);
            }
        }

        async function detectFace() {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            if (detections.length > 0) {
                facePosition = detections[0].box;
            } else {
                facePosition = null;
            }
        }

        function applyFilterLive() {
            if (!video.srcObject) return;
            liveCtx.save();
            liveCtx.imageSmoothingEnabled = true;
            liveCtx.imageSmoothingQuality = 'high';

            liveCtx.translate(liveCanvas.width, 0);
            liveCtx.scale(-1, 1);
            liveCtx.drawImage(video, 0, 0, liveCanvas.width, liveCanvas.height);
            liveCtx.restore();

            const imageData = liveCtx.getImageData(0, 0, liveCanvas.width, liveCanvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                let r = imageData.data[i];
                let g = imageData.data[i + 1];
                let b = imageData.data[i + 2];
                if (currentFilter === 'grayscale') {
                    const gray = 0.3 * r + 0.59 * g + 0.11 * b;
                    imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = gray;
                } else if (currentFilter === 'sepia') {
                    imageData.data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                    imageData.data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                    imageData.data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                } else if (currentFilter === 'vibrant') {
                    imageData.data[i] = Math.min(255, r * 1.2);
                    imageData.data[i + 1] = Math.min(255, g * 1.1);
                    imageData.data[i + 2] = Math.min(255, b * 1.2);
                } else if (currentFilter === 'warm') {
                    imageData.data[i] = Math.min(255, r * 1.1);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 0.8);
                } else if (currentFilter === 'cool') {
                    imageData.data[i] = Math.min(255, r * 0.8);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 1.1);
                } else if (currentFilter === 'retro') {
                    imageData.data[i] = Math.min(255, r * 0.8 + 40);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 0.7);
                } else if (currentFilter === 'dreamy') {
                    imageData.data[i] = Math.min(255, r + 20);
                    imageData.data[i + 1] = Math.min(255, g + 20);
                    imageData.data[i + 2] = Math.min(255, b + 40);
                } else if (currentFilter === 'invert') {
                    imageData.data[i] = 255 - r;
                    imageData.data[i + 1] = 255 - g;
                    imageData.data[i + 2] = 255 - b;
                }
            }
            liveCtx.putImageData(imageData, 0, 0);

            if (flashOn) {
                liveCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                liveCtx.fillRect(0, 0, liveCanvas.width, liveCanvas.height);
            }

            if (sticker !== 'none' && facePosition) {
                liveCtx.save();
                liveCtx.translate(liveCanvas.width, 0);
                liveCtx.scale(-1, 1);
                liveCtx.font = sticker === 'üêª' ? '150px Arial' : sticker === 'üê∞' ? '80px Arial' : '50px Arial';
                liveCtx.fillStyle = 'white';
                liveCtx.textAlign = 'center';
                const stickerX = liveCanvas.width - (facePosition.x + facePosition.width / 2);
                const stickerY = sticker === 'üê∞' ? facePosition.y - 50 : facePosition.y - 10;
                liveCtx.fillText(sticker, stickerX, stickerY);
                liveCtx.restore();
            }

            animationFrameId = requestAnimationFrame(applyFilterLive);
        }

        async function loadFaceApiModels() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model/');
                console.log('Face detection model ready');
                setInterval(detectFace, 100);
            } catch (err) {
                console.error('Error loading models:', err);
            }
        }

        Promise.all([loadFaceApiModels()]).then(() => console.log('Application ready'));

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cancelAnimationFrame(animationFrameId);
                liveCanvas.style.display = 'none';
            }
        }

        function displayPhotoPreview() {
            capturedPhotosContainer.innerHTML = '';
            const startIndex = Math.max(0, photos.length - 4);
            const displayPhotos = photos.slice(startIndex, startIndex + 4);
            displayPhotos.forEach((photo) => {
                if (photo) {
                    const img = document.createElement('img');
                    img.src = photo;
                    img.classList.add('photo-preview');
                    capturedPhotosContainer.appendChild(img);
                }
            });
        }

        snapBtn.addEventListener('click', () => takePhoto(timerSeconds));

        async function takePhoto(delay) {
            if (photos.length >= 8) {
                stopCamera();
                showPhotoSelection();
                return;
            }

            if (delay > 0) {
                snapBtn.disabled = true;
                for (let i = delay; i > 0; i--) {
                    snapBtn.innerHTML = i;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                snapBtn.innerHTML = 'üì∑';
                snapBtn.disabled = false;
            }

            cancelAnimationFrame(animationFrameId);
            ctx.drawImage(liveCanvas, 0, 0, canvas.width, canvas.height);

            photos.push(canvas.toDataURL('image/jpeg', 1.0));
            displayPhotoPreview();
            photoCount.textContent = `${photos.length}/8`;
            retakeButton.style.display = 'inline-block';
            if (photos.length >= 8) {
                snapBtn.disabled = true;
                stopCamera();
                showPhotoSelection();
            } else {
                applyFilterLive();
            }
        }

        // ...existing code...
        function showPhotoSelection() {
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('camera-controls').style.display = 'none';
            capturedPhotosContainer.style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            photoSelectionContainer.style.display = 'block';
            document.getElementById('photo-strip-container').style.display = 'none';
            document.getElementById('layout-actions').style.display = 'none';

            photoSelectionList.innerHTML = ''; // Clear previous list
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.classList.add('photo-selection');
                const img = document.createElement('img');
                img.src = photo;
                img.dataset.index = index; // Store index for later retrieval
                img.onclick = () => {
                    // Allow selection only if 4x1 layout might be chosen
                    if (document.querySelector('button[onclick="selectLayout(\'4x1\')"]')) {
                         // Limit selection to 4 images
                        const selectedCount = photoSelectionList.querySelectorAll('img.selected').length;
                        if (!img.classList.contains('selected') && selectedCount >= 4) {
                            alert('You can only select up to 4 photos for the 4x1 layout.');
                            return;
                        }
                        img.classList.toggle('selected');
                    }
                };
                div.appendChild(img);
                photoSelectionList.appendChild(div);
            });

             // Optionally disable/enable layout buttons based on photo count
             const btn4x1 = document.querySelector('button[onclick="selectLayout(\'4x1\')"]');
             const btn4x2 = document.querySelector('button[onclick="selectLayout(\'4x2\')"]');
             if (btn4x1) btn4x1.disabled = photos.length < 4;
             if (btn4x2) btn4x2.disabled = photos.length < 8; // Or allow 4x2 even with fewer photos

        }


        function selectLayout(layout) {
            currentLayout = layout;
            const selectedImagesElements = photoSelectionList.querySelectorAll('img.selected');

            if (layout === '4x1') {
                if (selectedImagesElements.length !== 4) {
                    alert('Please select exactly 4 photos for the 4x1 layout.');
                    return; // Stop if selection is not 4
                }
                // Get the actual photo data based on selected image elements
                selectedPhotos = Array.from(selectedImagesElements).map(img => {
                    const index = parseInt(img.dataset.index);
                    return photos[index]; // Get photo data from original array
                });
                rowsPerSide = 4;
                colsPerSide = 1;
                console.log('Selected photos for 4x1:', selectedPhotos);
            } else { // 4x2 layout
                // Use all available photos up to 8 for 4x2
                selectedPhotos = photos.slice(0, 8);
                rowsPerSide = 4;
                colsPerSide = 2;
                 if (selectedPhotos.length < 8) {
                    console.warn(`4x2 layout selected, but only ${selectedPhotos.length} photos available.`);
                 }
                console.log('Selected photos for 4x2:', selectedPhotos);
            }

            // Hide selection and show preview/customization
            photoSelectionContainer.style.display = 'none';
            document.getElementById('photo-strip-container').style.display = 'flex';
            photoStrip4x2.style.display = layout === '4x2' ? 'flex' : 'none';
            photoStrip1x4.style.display = layout === '4x1' ? 'flex' : 'none';
            updatePhotoStrip();
            document.getElementById('layout-actions').style.display = 'flex';
        }

        function goBack() {
            if (photos.length > 0) {
                photos.pop();
                displayPhotoPreview();
                photoCount.textContent = `${photos.length}/8`;
                snapBtn.disabled = false; // Re-enable snap button
                retakeButton.style.display = photos.length > 0 ? 'inline-block' : 'none';

                if (photos.length < 8) {
                    if (!video.srcObject) {
                        // Restart camera if it was stopped
                        startWebcam().then(() => {
                             // Ensure live canvas is shown after restart
                             liveCanvas.style.display = 'block';
                        });
                    } else {
                        // If camera is still running, ensure live feed is active and canvas shown
                        liveCanvas.style.display = 'block';
                        if (!animationFrameId) { // Restart rendering if stopped
                           applyFilterLive();
                        }
                    }
                }
                 // Hide selection/layout if user goes back from there
                 photoSelectionContainer.style.display = 'none';
                 document.getElementById('photo-strip-container').style.display = 'none';
                 document.getElementById('layout-actions').style.display = 'none';
                 // Show camera related elements
                 document.getElementById('video-container').style.display = 'block';
                 document.getElementById('camera-controls').style.display = 'flex';
                 document.getElementById('controls').style.display = 'flex'; // Show filter/sticker controls again
            }
        }

downloadButton.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'photobooth-strip.jpg';
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const photoWidth = 260; // Simplified, same width for both layouts in this logic
    const photoHeight = 240;
    const borderWidth = 50;
    const gap = currentLayout === '4x1' ? 0 : 40; // Changed '1x4' to '4x1'
    const photoGap = 10;

    canvas.width = currentLayout === '4x1' ? photoWidth + (borderWidth * 2) : (photoWidth * 2) + gap + (borderWidth * 2); // Changed '1x4' to '4x1'
    canvas.height = (photoHeight * rowsPerSide) + (photoGap * (rowsPerSide - 1)) + (borderWidth * 2);

    drawBackgroundOrFrame(ctx, canvas.width, canvas.height);

    let loadedImages = 0;
    selectedPhotos.slice(0, rowsPerSide * colsPerSide).forEach((photo, index) => {
        const img = new Image();
        img.src = photo;
        img.onload = () => {
            let x, y;
            if (currentLayout === '4x1') { // Changed '1x4' to '4x1'
                x = borderWidth;
                y = borderWidth + (index * (photoHeight + photoGap));
            } else {
                const side = index < rowsPerSide ? 0 : 1;
                const row = index % rowsPerSide;
                x = side === 0 ? borderWidth : borderWidth + photoWidth + gap;
                y = borderWidth + (row * (photoHeight + photoGap));
            }
            ctx.drawImage(img, x, y, photoWidth, photoHeight);
            loadedImages++;
            if (loadedImages === Math.min(selectedPhotos.length, rowsPerSide * colsPerSide)) {
                link.href = canvas.toDataURL('image/jpeg', 1.0);
                link.click();
            }
        };
        img.onerror = () => { // Added error handling for download
            console.error('Error loading image for download:', photo);
            loadedImages++; // Still increment to avoid blocking download if one image fails
            if (loadedImages === Math.min(selectedPhotos.length, rowsPerSide * colsPerSide)) {
                 // Attempt download even if some images failed
                 try {
                    link.href = canvas.toDataURL('image/jpeg', 1.0);
                    link.click();
                 } catch (e) {
                     console.error("Canvas toDataURL failed:", e);
                     alert("Failed to generate download image.");
                 }
            }
        };
    });
});


        // ...existing code...
        function drawBackgroundOrFrame(ctx, width, height) {
            ctx.fillStyle = frameColor;
            ctx.fillRect(0, 0, width, height);

            // Define relative margin/padding
            const margin = Math.min(width, height) * 0.08; // e.g., 8% of the smaller dimension
            const innerWidth = width - 2 * margin;
            const innerHeight = height - 2 * margin;

            if (frameType === 'custom') {
                if (customFrameImage.complete && customFrameImage.naturalHeight !== 0) {
                    // Draw custom image, potentially maintaining aspect ratio or filling
                    // This example fills the entire area. Adjust as needed.
                    ctx.drawImage(customFrameImage, 0, 0, width, height);
                } else {
                     // Fallback if custom image fails to load
                     ctx.fillStyle = frameColor; // Use selected background color
                     ctx.fillRect(0, 0, width, height);
                     ctx.fillStyle = '#cccccc'; // Add a placeholder or border
                     ctx.fillRect(margin, margin, innerWidth, innerHeight);
                     ctx.fillStyle = '#555555';
                     ctx.textAlign = 'center';
                     ctx.textBaseline = 'middle';
                     ctx.font = `bold ${height * 0.04}px Arial`;
                     ctx.fillText('Custom Frame', width / 2, height / 2);
                }
            } else {
                // Draw inner white rectangle relative to margins
                if (frameType !== 'none') { // Don't draw inner rect if no frame selected but color is
                   ctx.fillStyle = '#FFFFFF';
                   ctx.fillRect(margin, margin, innerWidth, innerHeight);
                }

                // Adjust frame details to be relative
                const baseFontSize = height * 0.05; // Base font size relative to height
                const stickerSize = height * 0.07; // Base sticker size

                switch (frameType) {
                    case 'summer':
                        // Background pattern (optional, keep simple or make relative)
                        const tileSize = 20; // Keep tile size fixed for simplicity here
                        ctx.fillStyle = '#00C4FF'; // Outer color
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#FFFFFF'; // Inner rect color
                        ctx.fillRect(margin, margin, innerWidth, innerHeight);

                        // Text
                        ctx.font = `bold ${baseFontSize * 0.8}px Arial`; // Slightly smaller font
                        ctx.fillStyle = '#FFC107';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom'; // Align text to bottom margin
                        ctx.fillText('SUMMER TIME!', width / 2, height - margin * 0.5);

                        // Stickers (position relative to margins and dimensions)
                        drawSticker(ctx, '‚òÄÔ∏è', margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üêö', width - margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üèñÔ∏è', width - margin * 1.5, margin * 3.0, stickerSize); // Adjust Y position
                        drawSticker(ctx, 'üçã', margin * 1.5, height / 2, stickerSize);
                        drawSticker(ctx, 'ü¶Ü', width - margin * 1.5, height / 2, stickerSize);
                        drawSticker(ctx, '‚≠ê', width - margin * 1.5, height - margin * 1.5, stickerSize);
                        // Clouds (position relative) - drawCloud might need adjustment too if fixed size
                        // drawCloud(ctx, width * 0.3, height - margin * 1.5, 50, 30); // Example relative positioning
                        // drawCloud(ctx, width * 0.7, height - margin * 1.5, 50, 30);
                        break;
                    case 'spring':
                        ctx.fillStyle = '#FFB6C1'; // Outer color
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#FFFFFF'; // Inner rect color
                        ctx.fillRect(margin, margin, innerWidth, innerHeight);
                        // Add relative spring elements if desired
                        drawSticker(ctx, 'üå∏', margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'ü¶ã', width - margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üå±', margin * 1.5, height - margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üê¶', width - margin * 1.5, height - margin * 1.5, stickerSize);
                        break;
                    case 'winter':
                        ctx.fillStyle = '#87CEEB'; // Outer color
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#FFFFFF'; // Inner rect color
                        ctx.fillRect(margin, margin, innerWidth, innerHeight);
                        // Add relative winter elements
                        drawSticker(ctx, '‚ùÑÔ∏è', margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, '‚òÉÔ∏è', width - margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, '‚òï', margin * 1.5, height - margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üß§', width - margin * 1.5, height - margin * 1.5, stickerSize);
                        break;
                    case 'heart':
                        ctx.fillStyle = '#FF69B4'; // Outer color
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#FFFFFF'; // Inner rect color
                        ctx.fillRect(margin, margin, innerWidth, innerHeight);
                        // Draw a relative heart shape (more complex, example kept simple)
                        ctx.fillStyle = '#FF1493';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        drawSticker(ctx, '‚ù§Ô∏è', width / 2, margin * 2.5, stickerSize * 1.5); // Big heart at top center
                        drawSticker(ctx, 'üíñ', margin * 1.5, height / 2, stickerSize * 0.8); // Smaller hearts
                        drawSticker(ctx, 'üíñ', width - margin * 1.5, height / 2, stickerSize * 0.8);
                        break;
                    case 'autumn':
                        ctx.fillStyle = '#FFA500'; // Outer color
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#FFFFFF'; // Inner rect color
                        ctx.fillRect(margin, margin, innerWidth, innerHeight);
                        // Add relative autumn elements
                        drawSticker(ctx, 'üçÅ', margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üçÇ', width - margin * 1.5, margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üéÉ', margin * 1.5, height - margin * 1.5, stickerSize);
                        drawSticker(ctx, 'üçÑ', width - margin * 1.5, height - margin * 1.5, stickerSize);
                        break;
                    // case 'none': // Handled by the initial fillRect and the check before the switch
                    // default: // Also handled
                    //     break;
                }
            }
        }
// ...existing code...

         resetLayoutButton.addEventListener('click', () => {
            // ... (existing reset logic) ...

            // Ensure camera elements are visible after full reset
            document.getElementById('video-container').style.display = 'block';
            document.getElementById('camera-controls').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            liveCanvas.style.display = 'block'; // Make sure live canvas is visible

            if (!video.srcObject) {
                startWebcam();
            } else if (!animationFrameId) {
                 applyFilterLive(); // Restart rendering if needed
            }
        });


        function toggleTimerOptions() {
            timerOptions.style.display = timerOptions.style.display === 'block' ? 'none' : 'block';
        }

        function setTimer(seconds) {
            timerSeconds = seconds;
            timerBtn.innerHTML = seconds === 0 ? '‚è≤Ô∏è' : `‚è≤Ô∏è ${seconds}s`;
            timerOptions.style.display = 'none';
        }

        async function switchCamera() {
            stopCamera();
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startWebcam();
        }

        function toggleFlash() {
            flashOn = !flashOn;
            flashBtn.classList.toggle('active', flashOn);
            applyFilterLive();
        }

        function drawCloud(ctx, x, y, width, height) {
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(x - width / 2 + 20, y, 20, Math.PI, 2 * Math.PI);
            ctx.arc(x, y - 10, 25, Math.PI, 2 * Math.PI);
            ctx.arc(x + width / 2 - 20, y, 20, Math.PI, 2 * Math.PI);
            ctx.arc(x, y + 10, 30, 0, Math.PI);
            ctx.closePath();
            ctx.fill();
        }

        function drawSticker(ctx, emoji, x, y, size) {
            ctx.font = `${size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, x, y);
        }

        function getCurrentPhotoStrip() {
            if (currentLayout === '4x2') return photoStrip4x2;
            if (currentLayout === '4x1') return photoStrip1x4;
            return null;
        }

        function resetPhotoStrip() {
            const currentStrip = getCurrentPhotoStrip();
            if (currentStrip) {
                const leftSide = currentStrip.querySelector('.left-side') || currentStrip.querySelector('.layout-preview');
                const rightSide = currentStrip.querySelector('.right-side');
                leftSide.innerHTML = rightSide ? (rightSide.innerHTML = '') : '';
                for (let i = 0; i < rowsPerSide; i++) {
                    const div = document.createElement('div');
                    div.textContent = 'Empty';
                    leftSide.appendChild(div.cloneNode(true));
                    if (rightSide) rightSide.appendChild(div);
                }
                currentStrip.style.background = '#FFFFFF';
            }
        }

        // filepath: c:\Users\Admin\Documents\photo1\test.html
// ...existing code...
function updatePhotoStrip() {
    const currentStrip = getCurrentPhotoStrip();
    if (!currentStrip) return;

    const leftSide = currentStrip.querySelector('.left-side') || currentStrip.querySelector('.layout-preview');
    const rightSide = currentStrip.querySelector('.right-side');
    leftSide.innerHTML = rightSide ? (rightSide.innerHTML = '') : '';

    console.log('Updating photo strip with photos:', selectedPhotos);
    const photoCount = currentLayout === '4x1' ? rowsPerSide : rowsPerSide * 2; // Changed '1x4' to '4x1'
    for (let i = 0; i < photoCount; i++) {
        const div = document.createElement('div');
        if (i < selectedPhotos.length && selectedPhotos[i]) {
            const img = new Image();
            img.src = selectedPhotos[i];
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.onerror = () => console.error('Error loading image:', selectedPhotos[i]);
            div.appendChild(img);
        } else {
            div.textContent = 'Empty';
        }
        if (currentLayout === '4x1' || i < rowsPerSide) { // Changed '1x4' to '4x1'
            leftSide.appendChild(div);
        } else {
            rightSide.appendChild(div);
        }
    }

    applyBackgroundOrFrame(currentStrip);
    currentStrip.classList.add('selected');
    currentStrip.style.display = 'flex';
}


        function applyBackgroundOrFrame(strip) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = strip.offsetWidth;
            canvas.height = strip.offsetHeight;

            drawBackgroundOrFrame(ctx, canvas.width, canvas.height);

            try {
                strip.style.background = `url(${canvas.toDataURL('image/png')}) no-repeat center`;
                strip.style.backgroundSize = 'cover';
                strip.style.border = 'none';
            } catch (e) {
                console.error('Error applying background:', e);
                strip.style.background = '#FFFFFF';
                strip.style.border = '10px solid #fff';
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            applyFilterLive();
            updateButtonSelection('filter-btn', filter);
        }

        function setSticker(stickerType) {
            sticker = stickerType;
            applyFilterLive();
            updateButtonSelection('sticker-btn', stickerType);
        }

        function setFrame(frame) {
            frameType = frame;
            updateButtonSelection('frame-btn', frame);
            updatePhotoStrip();
        }

        function setBackgroundColor(color) {
            frameColor = color;
            document.querySelector('.color-picker span').textContent = `Color: ${color}`;
            updateButtonSelection('background-btn', color);
            updatePhotoStrip();
        }

        function updateButtonSelection(className, value) {
            document.querySelectorAll(`.${className}`).forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('onclick')?.includes(value)) {
                    btn.classList.add('selected');
                }
            });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'flex';
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

function generateQRCode() {
    const qrCodeDiv = document.getElementById('qr-code');
    qrCodeDiv.style.display = 'block';
    qrCodeDiv.innerHTML = '';

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const photoWidth = 260; // Simplified
    const photoHeight = 240;
    const borderWidth = 50;
    const gap = currentLayout === '4x1' ? 0 : 40; // Changed '1x4' to '4x1'
    const photoGap = 10;

    canvas.width = currentLayout === '4x1' ? photoWidth + (borderWidth * 2) : (photoWidth * 2) + gap + (borderWidth * 2); // Changed '1x4' to '4x1'
    canvas.height = (photoHeight * rowsPerSide) + (photoGap * (rowsPerSide - 1)) + (borderWidth * 2);

    drawBackgroundOrFrame(ctx, canvas.width, canvas.height);

    let loadedImages = 0;
    selectedPhotos.slice(0, rowsPerSide * colsPerSide).forEach((photo, index) => {
        const img = new Image();
        img.src = photo;
        img.onload = () => {
            let x, y;
            if (currentLayout === '4x1') { // Changed '1x4' to '4x1'
                x = borderWidth;
                y = borderWidth + (index * (photoHeight + photoGap));
            } else {
                const side = index < rowsPerSide ? 0 : 1;
                const row = index % rowsPerSide;
                x = side === 0 ? borderWidth : borderWidth + photoWidth + gap;
                y = borderWidth + (row * (photoHeight + photoGap));
            }
            ctx.drawImage(img, x, y, photoWidth, photoHeight);
            loadedImages++;
            if (loadedImages === Math.min(selectedPhotos.length, rowsPerSide * colsPerSide)) {
                try { // Added try-catch for safety
                    const imageUrl = canvas.toDataURL('image/jpeg', 1.0);
                    QRCode.toCanvas(imageUrl, { width: 150 }, (err, qrCanvas) => {
                        if (err) {
                            console.error("QR Code generation failed:", err);
                            qrCodeDiv.innerHTML = 'Error generating QR Code.';
                        } else {
                            qrCodeDiv.appendChild(qrCanvas);
                        }
                    });
                } catch (e) {
                    console.error("Canvas toDataURL failed for QR Code:", e);
                    qrCodeDiv.innerHTML = 'Error preparing image for QR Code.';
                }
            }
        };
        img.onerror = () => { // Added error handling
            console.error('Error loading image for QR Code:', photo);
            loadedImages++; // Still increment
            if (loadedImages === Math.min(selectedPhotos.length, rowsPerSide * colsPerSide)) {
                qrCodeDiv.innerHTML = 'Error loading images for QR Code.'; // Indicate error
            }
        };
    });
}


        if (/Mobi|Android|iPhone|iPad/.test(navigator.userAgent)) {
            document.body.style.padding = '5px';
            document.querySelectorAll('button').forEach(btn => {
                btn.style.width = 'auto';
                btn.style.minWidth = '60px';
            });
        }
    </script>
</body>
</html>
