<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth Web</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
        #video { border: 2px solid #000; width: 480px; height: 360px; transform: scaleX(-1); }
        #canvas { display: none; width: 480px; height: 360px; }
        #photo-strip { margin-top: 20px; border: 10px solid #fff; }
        #controls { margin: 20px; }
        .filter-btn, .frame-color, .sticker-btn, .layout-btn { 
            padding: 10px; 
            margin: 5px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            border-radius: 5px; 
            transition: all 0.3s ease; 
        }
        .filter-btn:hover, .frame-color:hover, .sticker-btn:hover, .layout-btn:hover { 
            background: #ddd; 
        }
        .selected { 
            border: 2px solid #ff0000; 
            background: #e0e0e0; 
            font-weight: bold; 
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), 0 0 25px rgba(255, 0, 0, 0.4); 
        }
        .frame-color { 
            width: 30px; 
            height: 30px; 
            display: inline-block; 
        }
        #photo-strip-container { 
            margin-top: 20px; 
            display: flex; 
            justify-content: center; 
        }
        #retake, #download { 
            display: none; 
            padding: 10px; 
            margin: 5px; 
            cursor: pointer; 
            border: none; 
            border-radius: 5px; 
        }
        #retake { 
            background: #ff4444; 
            color: white; 
        }
        #retake:hover { 
            background: #cc0000; 
        }
        #download { 
            background: #4CAF50; 
            color: white; 
        }
        #download:hover { 
            background: #45a049; 
        }
    </style>
</head>
<body>
    <h1>Photobooth</h1>
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <button id="snap" disabled>Ch·ª•p ·∫£nh</button>
        <button id="retake">Ch·ª•p l·∫°i</button>
        <button id="save">L∆∞u ·∫£nh gh√©p</button>
        <button id="download">T·∫£i ·∫£nh xu·ªëng</button>
        <div>
            <h3>Ch·ªçn Layout</h3>
            <button class="layout-btn" onclick="setLayout(4, 2)">4x2</button>
            <button class="layout-btn" onclick="setLayout(6, 2)">6x2</button>
            <button class="layout-btn" onclick="setLayout(8, 2)">8x2</button>
        </div>
        <div>
            <h3>Ch·ªçn Filter</h3>
            <button class="filter-btn" onclick="setFilter('none')">Kh√¥ng filter</button>
            <button class="filter-btn" onclick="setFilter('grayscale')">ƒêen tr·∫Øng</button>
            <button class="filter-btn" onclick="setFilter('sepia')">Sepia</button>
            <button class="filter-btn" onclick="setFilter('vibrant')">R·ª±c r·ª°</button>
            <button class="filter-btn" onclick="setFilter('warm')">·∫§m</button>
            <button class="filter-btn" onclick="setFilter('cool')">M√°t m·∫ª</button>
            <button class="filter-btn" onclick="setFilter('retro')">Retro</button>
            <button class="filter-btn" onclick="setFilter('dreamy')">M∆° m√†ng</button>
            <button class="filter-btn" onclick="setFilter('invert')">ƒê·∫£o m√†u</button>
        </div>
        <div>
            <h3>Ch·ªçn m√†u khung</h3>
            <button class="frame-color" style="background: white;" onclick="setFrameColor('white')"></button>
            <button class="frame-color" style="background: pink;" onclick="setFrameColor('pink')"></button>
            <button class="frame-color" style="background: blue;" onclick="setFrameColor('blue')"></button>
            <button class="frame-color" style="background: yellow;" onclick="setFrameColor('yellow')"></button>
            <button class="frame-color" style="background: green;" onclick="setFrameColor('green')"></button>
        </div>
        <div>
            <h3>Ch·ªçn Sticker</h3>
            <button class="sticker-btn" onclick="setSticker('none')">Kh√¥ng sticker</button>
            <button class="sticker-btn" onclick="setSticker('üò∫')">M√®o</button>
            <button class="sticker-btn" onclick="setSticker('üëë')">V∆∞∆°ng mi·ªán</button>
            <button class="sticker-btn" onclick="setSticker('üåü')">Ng√¥i sao</button>
            <button class="sticker-btn" onclick="setSticker('üêª')">G·∫•u b·ª±</button>
            <button class="sticker-btn" onclick="setSticker('üê∞')">Tai th·ªè</button>
            <button class="sticker-btn" onclick="setSticker('‚ù§Ô∏è')">Tr√°i tim</button>
        </div>
    </div>
    <div id="photo-strip-container">
        <img id="photo-strip" src="" alt="Photo strip">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const photoStrip = document.getElementById('photo-strip');
        const retakeButton = document.getElementById('retake');
        const downloadButton = document.getElementById('download');
        let photos = [];
        let currentFilter = 'none';
        let frameColor = 'white';
        let sticker = 'none';
        let rows = 0;
        let cols = 0;
        let isLayoutSelected = false;
        let stream = null;

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ truy c·∫≠p webcam:', err);
                alert('Kh√¥ng th·ªÉ truy c·∫≠p webcam: ' + err.message);
            }
        }

        async function loadFaceApiModels() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model/');
                console.log('M√¥ h√¨nh nh·∫≠n di·ªán ƒë√£ s·∫µn s√†ng');
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t:', err);
            }
        }

        Promise.all([startWebcam(), loadFaceApiModels()]).then(() => {
            console.log('·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng');
        });

        document.getElementById('snap').addEventListener('click', async () => {
            if (photos.length >= rows * cols) return;

            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            // Nh·∫≠n di·ªán khu√¥n m·∫∑t v√† th√™m sticker
            if (sticker !== 'none') {
                const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());
                if (detections.length > 0) {
                    const face = detections[0].box;
                    ctx.font = sticker === 'üêª' ? '150px Arial' : sticker === 'üê∞' ? '80px Arial' : '50px Arial';
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    const stickerX = face.x + face.width / 2;
                    const stickerY = sticker === 'üê∞' ? face.y - 50 : face.y - 10;
                    ctx.fillText(sticker, stickerX, stickerY);
                }
            }

            // √Åp d·ª•ng filter
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                let r = imageData.data[i];
                let g = imageData.data[i + 1];
                let b = imageData.data[i + 2];
                if (currentFilter === 'grayscale') {
                    const gray = 0.3 * r + 0.59 * g + 0.11 * b;
                    imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = gray;
                } else if (currentFilter === 'sepia') {
                    imageData.data[i] = r * 0.393 + g * 0.769 + b * 0.189;
                    imageData.data[i + 1] = r * 0.349 + g * 0.686 + b * 0.168;
                    imageData.data[i + 2] = r * 0.272 + g * 0.534 + b * 0.131;
                } else if (currentFilter === 'vibrant') {
                    imageData.data[i] = Math.min(255, r * 1.2);
                    imageData.data[i + 1] = Math.min(255, g * 1.1);
                    imageData.data[i + 2] = Math.min(255, b * 1.2);
                } else if (currentFilter === 'warm') {
                    imageData.data[i] = Math.min(255, r * 1.1);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 0.8);
                } else if (currentFilter === 'cool') {
                    imageData.data[i] = Math.min(255, r * 0.8);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 1.1);
                } else if (currentFilter === 'retro') {
                    imageData.data[i] = Math.min(255, r * 0.8 + 40);
                    imageData.data[i + 1] = Math.min(255, g * 0.9);
                    imageData.data[i + 2] = Math.min(255, b * 0.7);
                } else if (currentFilter === 'dreamy') {
                    imageData.data[i] = Math.min(255, r + 20);
                    imageData.data[i + 1] = Math.min(255, g + 20);
                    imageData.data[i + 2] = Math.min(255, b + 40);
                } else if (currentFilter === 'invert') {
                    imageData.data[i] = 255 - r;
                    imageData.data[i + 1] = 255 - g;
                    imageData.data[i + 2] = 255 - b;
                }
            }
            ctx.putImageData(imageData, 0, 0);

            photos.push(canvas.toDataURL());
            updatePhotoStrip();
            retakeButton.style.display = 'inline-block';
            if (photos.length >= rows * cols) {
                document.getElementById('snap').disabled = true;
                downloadButton.style.display = 'inline-block';
            }
        });

        retakeButton.addEventListener('click', () => {
            if (photos.length > 0) {
                photos.pop();
                updatePhotoStrip();
                document.getElementById('snap').disabled = false;
                retakeButton.style.display = 'none';
                downloadButton.style.display = 'none';
            }
        });

        document.getElementById('save').addEventListener('click', () => {
            if (photos.length === 0) return;
            const stripCanvas = document.createElement('canvas');
            const photoWidth = 240;
            const photoHeight = 180;
            stripCanvas.width = photoWidth * cols;
            stripCanvas.height = photoHeight * rows;
            const stripCtx = stripCanvas.getContext('2d');

            stripCtx.fillStyle = frameColor;
            stripCtx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);

            photos.forEach((photo, index) => {
                const img = new Image();
                img.src = photo;
                img.onload = () => {
                    const row = Math.floor(index / cols);
                    const col = index % cols;
                    stripCtx.drawImage(img, col * photoWidth, row * photoHeight, photoWidth, photoHeight);
                    if (index === photos.length - 1) {
                        photoStrip.src = stripCanvas.toDataURL();
                        downloadButton.style.display = 'inline-block';
                    }
                };
            });
        });

        downloadButton.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'photobooth-strip.png';
            link.href = photoStrip.src;
            link.click();
        });

        function updatePhotoStrip() {
            const stripCanvas = document.createElement('canvas');
            const photoWidth = 240;
            const photoHeight = 180;
            stripCanvas.width = photoWidth * cols;
            stripCanvas.height = photoHeight * rows;
            const stripCtx = stripCanvas.getContext('2d');

            stripCtx.fillStyle = frameColor;
            stripCtx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);

            photos.forEach((photo, index) => {
                const img = new Image();
                img.src = photo;
                img.onload = () => {
                    const row = Math.floor(index / cols);
                    const col = index % cols;
                    stripCtx.drawImage(img, col * photoWidth, row * photoHeight, photoWidth, photoHeight);
                    photoStrip.src = stripCanvas.toDataURL();
                };
            });

            if (photos.length === 0) {
                photoStrip.src = stripCanvas.toDataURL();
            }
        }

        function setLayout(newRows, newCols) {
            rows = newRows;
            cols = newCols;
            photos = [];
            isLayoutSelected = true;
            document.getElementById('snap').disabled = false;
            updatePhotoStrip();
            updateButtonSelection('layout-btn', `${rows}x${cols}`);
        }

        function setFilter(filter) {
            currentFilter = filter;
            updateButtonSelection('filter-btn', filter);
        }

        function setFrameColor(color) {
            frameColor = color;
            updatePhotoStrip();
            updateButtonSelection('frame-color', color);
        }

        function setSticker(stickerType) {
            sticker = stickerType;
            updateButtonSelection('sticker-btn', stickerType);
        }

        function updateButtonSelection(className, value) {
            document.querySelectorAll(`.${className}`).forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('onclick').includes(value)) {
                    btn.classList.add('selected');
                }
            });
        }
    </script>
</body>
</html>